---
kind: pipeline
type: docker
name: default

steps:
  - name: test
    image: golang:1.18
    pull: if-not-exists
    commands:
      - go clean -testcache
      - go test ./... -v
    volumes:
      - name: go-cache
        path: /go/pkg/mod
  - name: build
    image: goreleaser/goreleaser
    pull: if-not-exists
    commands:
      - goreleaser build --snapshot --rm-dist
    volumes:
      - name: go-cache
        path: /go/pkg/mod

  - name: push
    image: thegeeklab/drone-docker-buildx
    privileged: true
    pull: if-not-exists
    settings:
      platforms:
        - linux/amd64
        - linux/arm64
      context: dist

volumes:
  - name: go-cache
    temp: {}